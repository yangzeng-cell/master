import Settings from"./settings.js";import Awesome from"../dynamic/awesome.js";import MSG_TYPE from"../static/js/common.js";new Vue({el:"#pageContainer",data:{es6Support:!0,defaultKey:"Alt+Shift+J",selectedOpts:[],manifest:{},fhTools:{},menuFeHelperSeting:!1,menuDownloadCrx:!1,sortArray:[],donate:{text:"微信打赏！鼓励升级！",image:"./donate.jpeg"},countDown:0,isFirefox:/Firefox/.test(navigator.userAgent)},created:function(){!this.isFirefox&&DarkModeMgr.turnLightAuto(),this.initData(),this.shortCut(),this.remoteUpgrade(),this.remoteHotFix()},methods:{initData:function(){this.manifest=chrome.runtime.getManifest(),Settings.getOptions(e=>{this.selectedOpts=Object.keys(e).filter(t=>"true"===String(e[t]))}),this.sortArray=Awesome.SortToolMgr.get(),Awesome.menuMgr("fehelper-setting","get").then(e=>{this.menuFeHelperSeting="0"!==String(e)}),Awesome.menuMgr("download-crx","get").then(e=>{this.menuDownloadCrx="1"===String(e)}),Awesome.getAllTools().then(e=>{this.fhTools=e;let t=!this.sortArray.length;Object.keys(e).forEach(o=>{e[o].installed&&(t&&"devtools"!==o&&this.sortArray.push(o),!e[o]._devTool&&Awesome.checkUpgrade(o).then(e=>{this.fhTools[o].upgrade=e}))}),this.sortTools()})},shortCut:function(){chrome.commands&&chrome.commands.getAll&&chrome.commands.getAll(e=>{e.some(e=>{if("_execute_browser_action"===e.name&&e.shortcut)return this.defaultKey=e.shortcut,!0})})},sortTools:function(e){let t={},o={};Object.keys(this.fhTools).forEach(e=>{this.fhTools[e].installed&&(o[e]=this.fhTools[e])}),this.sortArray.length?(this.sortArray.forEach(e=>{t[e]=o[e]}),Awesome.SortToolMgr.set(this.sortArray)):t=o,Object.keys(this.fhTools).forEach(e=>{t[e]||(t[e]=this.fhTools[e])}),this.fhTools=t,this.$forceUpdate(),e&&chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"menu-upgrade",showTips:!1,menuOnly:!0})},sortUp:function(e){this.sortArray[e]=this.sortArray.splice(e-1,1,this.sortArray[e])[0],this.sortTools(!0)},sortDown:function(e){this.sortArray[e]=this.sortArray.splice(e+1,1,this.sortArray[e])[0],this.sortTools(!0)},remoteUpgrade:function(){let remoteUpgradeUrl=`${this.manifest.homepage_url}/static/js/awesome.js?v=${1*new Date}`;fetch(remoteUpgradeUrl).then(e=>e.text()).then(jsText=>{try{if(!jsText)return!1;eval(jsText),Object.keys(RemoteAwesome.newTools).forEach(e=>{this.fhTools[e]?(this.fhTools[e].name=RemoteAwesome.newTools[e].name||this.fhTools[e].name,this.fhTools[e].tips=RemoteAwesome.newTools[e].tips||this.fhTools[e].tips,this.fhTools[e].menuConfig=RemoteAwesome.newTools[e].menuConfig||this.fhTools[e].menuConfig,void 0!==RemoteAwesome.newTools[e].contentScript&&this.fhTools[e].contentScript!==RemoteAwesome.newTools[e].contentScript&&(this.fhTools[e].contentScript=RemoteAwesome.newTools[e].contentScript,this.fhTools[e].upgrade=!0),void 0!==RemoteAwesome.newTools[e].contentScriptCss&&this.fhTools[e].contentScriptCss!==RemoteAwesome.newTools[e].contentScriptCss&&(this.fhTools[e].contentScriptCss=RemoteAwesome.newTools[e].contentScriptCss,this.fhTools[e].upgrade=!0),void 0!==RemoteAwesome.newTools[e].offloadForbid&&this.fhTools[e].offloadForbid!==RemoteAwesome.newTools[e].offloadForbid&&(this.fhTools[e].offloadForbid=RemoteAwesome.newTools[e].offloadForbid,this.fhTools[e].upgrade=!0)):this.fhTools[e]=RemoteAwesome.newTools[e]}),RemoteAwesome.removedTools.forEach(e=>{delete this.fhTools[e]}),this.$forceUpdate(),Awesome.CodeCacheMgr.set(jsText)}catch(e){console.log(e)}}).catch(e=>console.log("远程更新失败：",e))},remoteHotFix:function(){let hotfix=()=>{let remoteHotfixUrl=`${this.manifest.homepage_url}/static/js/hotfix.js?v=${(new Date).toLocaleDateString()}`;fetch(remoteHotfixUrl).then(e=>e.text()).then(jsText=>{try{if(!jsText)return!1;eval(jsText)}catch(e){}}).catch(e=>console.log("远程热修复失败：",e))};setTimeout(hotfix,2e3)},close:()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.tabs.remove(e[0].id)})},cancel:function(){this.close()},save:function(){Settings.setOptions(this.selectedOpts,()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_ANY_THING,func:((e,t)=>{Menu.manage(Settings),notifyText({message:"配置修改已生效，请继续使用!",autoClose:2e3})}).toString()}),DarkModeMgr.turnLightAuto()});let e=this.menuFeHelperSeting?"install":"offload",t=this.menuDownloadCrx?"install":"offload";Awesome.menuMgr("fehelper-setting",e).then(()=>{Awesome.menuMgr("download-crx",t).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${t}`,showTips:!1,menuOnly:!0})})})},setShortcuts:function(){return chrome.tabs.create({url:"chrome://extensions/shortcuts"}),!1},donateToggle:function(e){let t=this.$refs.boxDonate;t.classList.contains("hide")?(t.classList.remove("hide"),t.style.top=e.target.offsetTop+30+"px",t.style.left=e.target.offsetLeft+"px"):t.classList.add("hide")},installOrUpgrade:function(e,t){let o=t.target;if("i"===o.tagName.toLowerCase()&&(o=o.parentNode),"1"===o.getAttribute("data-undergoing"))return!1;o.setAttribute("data-undergoing",1);let s=o.querySelector("span.x-progress");Awesome.install(e,e=>{s.textContent=`(${e})`}).then(()=>{this.fhTools[e].upgrade&&(this.fhTools[e].upgrade=!1),chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,toolName:e,action:this.fhTools[e].installed?"upgrade":"install",showTips:!0,backgroundScript:this.fhTools[e].backgroundScript}),this.$nextTick(()=>{o.setAttribute("data-undergoing",0),s.textContent="(100%)",setTimeout(()=>{this.fhTools[e].installed=!0,s.textContent="",this.sortArray.includes(e)||"devtools"===e||this.sortArray.push(e),this.sortTools()},500)})},e=>{o.setAttribute("data-undergoing",0),alert("可能是网络状态不太好，请稍后再试...")})},offLoad:function(e,t){if("1"===t.target.getAttribute("data-undergoing"))return!1;t.target.setAttribute("data-undergoing",1),Awesome.offLoad(e).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"offload",showTips:!0}),this.fhTools[e].installed=!1,t.target.setAttribute("data-undergoing",0);let o=this.sortArray.indexOf(e);-1!==o&&this.sortArray.splice(o,1),Awesome.menuMgr(e,"offload").then(()=>{this.fhTools[e].menu=!1,chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"menu-offload",showTips:!1,menuOnly:!0}),this.sortTools()})})},menuMgr:function(e,t){if("1"===t.target.getAttribute("data-undergoing"))return!1;t.target.setAttribute("data-undergoing",1);let o=this.fhTools[e].menu,s=o?"offload":"install";Awesome.menuMgr(e,s).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${s}`,showTips:!0,menuOnly:!0}),this.fhTools[e].menu=!o,t.target.setAttribute("data-undergoing",0),this.$forceUpdate()})},turnLight(e){e.preventDefault(),e.stopPropagation(),DarkModeMgr.turnLight(!0),this.countDown=5;let t=setInterval(()=>{0===this.countDown?(DarkModeMgr.turnLight(!1),clearInterval(t)):this.countDown--},1e3)},openFeOnline:function(){chrome.tabs.create({url:this.manifest.homepage_url})}}});